<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GoG × Contradiction Debt — Moral Topology (Preloaded + Trajectories)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  :root { --bg:#0e1116; --panel:#161a22; --muted:#aab2c0; --accent:#2dd4bf; --warn:#f59e0b; --danger:#ef4444;}
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#e6e8ee; background:var(--bg);}
  #header { padding:14px 18px; background:#0b0e13; border-bottom:1px solid #1d2430;}
  #wrap { display:grid; grid-template-columns: 430px 1fr; gap:0; min-height: calc(100vh - 58px);}
  #left { background:var(--panel); border-right:1px solid #1d2430; padding:12px 14px; overflow:auto;}
  #right { display:flex; flex-direction:column;}
  #plot { flex:1 1 auto; height: calc(100vh - 320px);}
  h1 { font-size:18px; margin:0 0 6px 0; color:#e6e8ee;}
  .sub { color:var(--muted); font-size:13px; line-height:1.3; margin-bottom:10px;}
  .section { margin:12px 0 14px 0; padding:10px; background:#111522; border:1px solid #20283a; border-radius:8px;}
  .section h3 { margin:4px 0 8px 0; font-size:14px; color:#e6e8ee;}
  label { display:block; margin:6px 0; font-size:13px;}
  input[type="number"], input[type="text"] { width:100%; padding:6px 8px; border-radius:6px; border:1px solid #2a3346; background:#0f1320; color:#e6e8ee;}
  input[type="range"] { width:100%;}
  input[type="checkbox"] { transform: translateY(1px); }
  button { cursor:pointer; background:#1a2233; color:#e6e8ee; border:1px solid #2a3346; padding:7px 10px; border-radius:6px; }
  button.primary { background: var(--accent); color:#0e1116; border:none; font-weight:600;}
  .row { display:flex; gap:8px; }
  .row > * { flex:1; }
  .legend { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;}
  .chip { display:flex; align-items:center; gap:6px; background:#101622; border:1px solid #22304b; padding:4px 8px; border-radius:999px; font-size:12px; color:#d8dee9;}
  .dot { width:10px; height:10px; border-radius:50%;}
  .dot.plural { background:#22c55e;}
  .dot.auth { background:#f59e0b;}
  .dot.coll { background:#ef4444;}
  .dot.band1 { background:#16a34a;}
  .dot.band2 { background:#84cc16;}
  .dot.band3 { background:#f59e0b;}
  .dot.band4 { background:#ef4444;}
  .note { color:#aab2c0; font-size:12px; margin-top:6px; }
  .small { font-size:12px; color:#cdd3df; }
  .hr { border-top:1px dashed #2a3346; margin:10px 0; }
  #caseList { max-height:240px; overflow:auto; padding:6px; background:#0f1320; border:1px solid #22304b; border-radius:8px;}
  .case-item { display:flex; align-items:center; gap:6px; padding:3px 0; font-size:12px;}
  .controls-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  details summary { cursor: pointer; color:#dbe3f1; }
  #insight { padding:12px 16px; min-height:150px; background:#0f1320; border-top:1px solid #1d2430;}
  .mode { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
</style>
</head>
<body>
  <div id="header">
    <h1>Geometry of the Good × Contradiction Debt — Moral Topology (Preloaded + Trajectories)</h1>
    <div class="sub">
      Default: stylized moral terrain (theory). Optional: data-aligned surface + contours + residuals. Toggle static vs. compare trajectories. Axes: X=capacity_factor (trust), Y=effective repair R (fulfillment proxy), Z=rupture_probability = 1 − R/V (debt proxy).
    </div>
  </div>

  <div id="wrap">
    <div id="left">
      <div class="section">
        <h3>Concept-to-data mapping</h3>
        <div class="small">
          - <b>X (Trust density):</b> capacity_factor = mean(L, E, K).<br>
          - <b>Y (Fulfillment proxy):</b> effective repair R = repair_avg × capacity_factor.<br>
          - <b>Z (Debt proxy):</b> rupture_probability = 1 − R/V (monotonic with contradiction debt).<br>
          <div class="hr"></div>
          <b>Interpretation:</b> Higher X,Y with lower Z indicates a stable basin; lower X/Y with higher Z indicates rupture valleys.
        </div>
      </div>

      <div class="section">
        <h3>Mode & layers</h3>
        <div class="mode">
          <label><input type="radio" name="mode" id="modeStatic" checked> Static field</label>
          <label><input type="radio" name="mode" id="modeTraj"> Compare trajectories</label>
        </div>
        <div class="hr"></div>
        <label><input type="checkbox" id="toggleStylized" checked> Stylized GoG surface (theory)</label>
        <label><input type="checkbox" id="toggleFitted"> Data-aligned fitted surface (with contours)</label>
        <label><input type="checkbox" id="toggleContours" checked> Label contours on fitted surface</label>
        <label><input type="checkbox" id="toggleResiduals"> Residual overlay (data − theory)</label>
        <label><input type="checkbox" id="togglePluralist" checked> Pluralist/Utopian trajectory</label>
        <label><input type="checkbox" id="toggleAuthoritarian" checked> Authoritarian trajectory</label>
        <label><input type="checkbox" id="toggleCollapsed" checked> Collapsed/Anomic trajectory</label>
        <label><input type="checkbox" id="toggleCases" checked> CSV cases</label>
        <div class="legend">
          <span class="chip"><span class="dot plural"></span>Pluralist</span>
          <span class="chip"><span class="dot auth"></span>Authoritarian</span>
          <span class="chip"><span class="dot coll"></span>Collapsed</span>
        </div>
      </div>

      <div class="section">
        <h3>Metric transforms & smoothing</h3>
        <label><input type="checkbox" id="normalizeXY"> Normalize X,Y to [0,1] (data)</label>
        <label><input type="checkbox" id="logitZ"> Logit transform Z (both theory & data)</label>
        <label>Smoother sigma (fitted surface)
          <input type="range" id="sigma" min="0.08" max="0.40" step="0.01" value="0.20">
        </label>
        <div class="note">If residuals shrink under transforms, divergence is likely measurement-driven; if they persist, that invites theory refinement.</div>
      </div>

      <div class="section">
        <h3>Case filters & toggles</h3>
        <div class="controls-row">
          <label><input type="checkbox" id="band4" checked> <span class="dot band4"></span> R/V < 0.30 (1–2 q)</label>
          <label><input type="checkbox" id="band3" checked> <span class="dot band3"></span> 0.30–0.45 (2–3 q)</label>
          <label><input type="checkbox" id="band2" checked> <span class="dot band2"></span> 0.45–0.60 (3–6 q)</label>
          <label><input type="checkbox" id="band1" checked> <span class="dot band1"></span> ≥ 0.60 (8+ q)</label>
        </div>
        <div class="controls-row">
          <input type="text" id="search" placeholder="Search country..." />
          <button id="selectAll">Select all</button>
          <button id="selectNone">None</button>
          <label><input type="checkbox" id="showLabels"> Show labels</label>
        </div>
        <div id="caseList"></div>
        <div class="note">Toggle any country-year; filters apply to the list and the plot.</div>
      </div>

      <div class="section">
        <h3>Add a custom case</h3>
        <div class="small">
          Enter CD inputs; we compute \(R_\text{eff} = \text{repair\_avg}\cdot \text{capacity\_factor}\), \(R/V\), and map to (X,Y,Z).
          <div class="hr"></div>
          <div class="row">
            <div><label>Case name<input type="text" id="caseName" placeholder="e.g., Nepal Q3 2025" /></label></div>
          </div>
          <div class="row">
            <div><label>V_total (0–2)<input type="number" id="V" min="0" max="2" step="0.01" value="0.94" /></label></div>
            <div><label>repair_avg (0–1)<input type="number" id="Ravg" min="0" max="1" step="0.01" value="0.50" /></label></div>
          </div>
          <div class="row">
            <div><label>capacity_factor (0–1)<input type="number" id="Cap" min="0" max="1" step="0.01" value="0.45" /></label></div>
            <div><label>Optional X override<input type="number" id="Xoverride" min="0" max="1" step="0.01" placeholder="blank uses capacity_factor" /></label></div>
          </div>
          <div class="row">
            <button class="primary" id="addCase">Add/Update case</button>
            <button id="clearCases">Clear custom</button>
          </div>
          <div class="note">Defaults: X=capacity_factor, Y=R (effective repair), Z=1 − R/V.</div>
        </div>
      </div>
    </div>

    <div id="right">
      <div id="plot"></div>
      <div id="insight">Click any point for CD decomposition and GoG interpretation.</div>
    </div>
  </div>

<script>
/* ===================== Embedded CSV (preloaded from your attachment) ===================== */
const CSV_DATA = `Country,Year,Total,V_total,R,R_V_ratio,capacity_factor,band,rupture_probability,rupture_occurred
Somalia,2023,111.9,9.325,0.6750000000000007,0.0723860589812333,0.0675000000000001,1-2 quarters,0.9638069705093834,0
Yemen,2023,108.9,9.075,0.9250000000000008,0.1019283746556474,0.0925,1-2 quarters,0.9490358126721764,0
South Sudan,2023,108.5,9.041666666666668,0.958333333333332,0.1059907834101381,0.0958333333333332,1-2 quarters,0.9470046082949308,0
Congo Democratic Republic,2023,107.19999999999996,8.933333333333332,1.0666666666666682,0.119402985074627,0.1066666666666669,1-2 quarters,0.9402985074626864,0
Syria,2023,107.1,8.925,1.0749999999999993,0.1204481792717085,0.1074999999999999,1-2 quarters,0.9397759103641457,0
Afghanistan,2023,106.6,8.883333333333335,1.1166666666666654,0.1257035647279548,0.1116666666666665,1-2 quarters,0.9371482176360226,0
Sudan,2023,106.2,8.85,1.1500000000000004,0.1299435028248588,0.1150000000000001,1-2 quarters,0.9350282485875706,0
Central African Republic,2023,105.70000000000002,8.808333333333335,1.1916666666666649,0.1352885525070953,0.1191666666666665,1-2 quarters,0.9323557237464524,0
Chad,2023,104.6,8.716666666666667,1.2833333333333332,0.147227533460803,0.1283333333333333,1-2 quarters,0.9263862332695983,0
Haiti,2023,102.9,8.575,1.4250000000000007,0.1661807580174928,0.1425,1-2 quarters,0.9169096209912536,0
Ethiopia,2023,100.4,8.366666666666665,1.6333333333333346,0.1952191235059762,0.1633333333333334,1-2 quarters,0.9023904382470118,0
Myanmar,2023,100.19999999999996,8.349999999999998,1.650000000000002,0.1976047904191619,0.1650000000000002,1-2 quarters,0.901197604790419,0
Mali,2023,99.5,8.291666666666666,1.708333333333334,0.2060301507537689,0.1708333333333332,1-2 quarters,0.8969849246231155,0
Guinea,2023,98.5,8.208333333333334,1.791666666666666,0.2182741116751268,0.1791666666666665,1-2 quarters,0.8908629441624366,0
Nigeria,2023,98.0,8.166666666666666,1.833333333333334,0.2244897959183674,0.1833333333333334,1-2 quarters,0.8877551020408163,0
Zimbabwe,2023,96.9,8.075000000000001,1.924999999999999,0.2383900928792568,0.1925,1-2 quarters,0.8808049535603716,0
Libya,2023,96.1,8.008333333333333,1.9916666666666671,0.2486992715920916,0.1991666666666667,1-2 quarters,0.8756503642039541,0
Ukraine,2023,95.9,7.991666666666666,2.0083333333333337,0.251303441084463,0.2008333333333334,1-2 quarters,0.8743482794577685,0
Eritrea,2023,94.5,7.874999999999999,2.125000000000001,0.26984126984127,0.2125000000000001,1-2 quarters,0.865079365079365,0
Burundi,2023,94.2,7.849999999999999,2.150000000000001,0.2738853503184715,0.215,1-2 quarters,0.8630573248407643,0
Burkina Faso,2023,94.0,7.833333333333335,2.166666666666665,0.2765957446808508,0.2166666666666665,1-2 quarters,0.8617021276595747,0
Mozambique,2023,94.0,7.833333333333333,2.166666666666667,0.2765957446808511,0.2166666666666666,1-2 quarters,0.8617021276595744,0
Cameroon,2023,94.0,7.833333333333332,2.166666666666668,0.2765957446808512,0.2166666666666667,1-2 quarters,0.8617021276595744,0
Niger,2023,93.4,7.783333333333332,2.216666666666668,0.2847965738758031,0.2216666666666668,1-2 quarters,0.8576017130620984,0
Lebanon,2023,91.79999999999998,7.649999999999999,2.3500000000000014,0.3071895424836603,0.2350000000000001,1-2 quarters,0.8464052287581698,0
Uganda,2023,91.5,7.625,2.375,0.3114754098360656,0.2375,1-2 quarters,0.8442622950819672,0
Iraq,2023,91.4,7.616666666666666,2.3833333333333337,0.312910284463895,0.2383333333333334,1-2 quarters,0.8435448577680524,0
Congo Republic,2023,90.7,7.558333333333334,2.4416666666666664,0.3230429988974641,0.2441666666666666,1-2 quarters,0.8384785005512679,0
Venezuela,2023,90.5,7.541666666666667,2.458333333333333,0.3259668508287292,0.2458333333333333,1-2 quarters,0.8370165745856354,0
Sri Lanka,2023,90.3,7.525000000000001,2.4749999999999988,0.3289036544850496,0.2474999999999999,1-2 quarters,0.8355481727574752,1
Guinea Bissau,2023,89.90000000000002,7.491666666666668,2.508333333333332,0.3348164627363735,0.2508333333333331,1-2 quarters,0.8325917686318133,0
Pakistan,2023,89.89999999999999,7.491666666666666,2.5083333333333337,0.3348164627363738,0.2508333333333333,1-2 quarters,0.8325917686318131,0
Liberia,2023,88.89999999999999,7.408333333333332,2.591666666666668,0.3498312710911138,0.2591666666666667,1-2 quarters,0.8250843644544431,0
Palestine,2023,87.9,7.325,2.675,0.3651877133105802,0.2674999999999999,1-2 quarters,0.81740614334471,0
Kenya,2023,87.8,7.316666666666666,2.6833333333333336,0.3667425968109339,0.2683333333333333,1-2 quarters,0.816628701594533,0
Cote d'Ivoire,2023,87.10000000000001,7.258333333333334,2.7416666666666663,0.3777267508610791,0.2741666666666665,1-2 quarters,0.8111366245694605,0
Mauritania,2023,87.0,7.25,2.75,0.3793103448275862,0.275,1-2 quarters,0.8103448275862069,0
North Korea,2023,87.0,7.25,2.75,0.3793103448275862,0.275,1-2 quarters,0.8103448275862069,0
Angola,2023,86.9,7.241666666666667,2.758333333333333,0.3808975834292289,0.2758333333333332,1-2 quarters,0.8095512082853855,0
Iran,2023,85.39999999999999,7.116666666666666,2.8833333333333337,0.405152224824356,0.2883333333333334,1-2 quarters,0.797423887587822,0
Bangladesh,2023,85.19999999999999,7.099999999999999,2.900000000000001,0.4084507042253523,0.2900000000000001,1-2 quarters,0.7957746478873238,0
Equatorial Guinea,2023,84.4,7.033333333333334,2.966666666666666,0.4218009478672984,0.2966666666666666,1-2 quarters,0.7890995260663508,0
Malawi,2023,83.2,6.933333333333334,3.0666666666666664,0.4423076923076922,0.3066666666666666,1-2 quarters,0.7788461538461539,0
Rwanda,2023,82.30000000000001,6.858333333333334,3.1416666666666657,0.4580801944106923,0.3141666666666666,1-2 quarters,0.7709599027946539,0
Comoros,2023,82.2,6.8500000000000005,3.1499999999999995,0.45985401459854,0.3149999999999999,1-2 quarters,0.7700729927007299,0
Djibouti,2023,82.19999999999999,6.849999999999999,3.150000000000001,0.4598540145985404,0.315,1-2 quarters,0.7700729927007298,0
Togo,2023,82.1,6.841666666666666,3.158333333333334,0.4616321559074301,0.3158333333333334,1-2 quarters,0.7691839220462849,0
Zambia,2023,81.8,6.816666666666666,3.1833333333333336,0.4669926650366748,0.3183333333333333,1-2 quarters,0.7665036674816625,0
Madagascar,2023,81.7,6.808333333333334,3.1916666666666664,0.4687882496940024,0.3191666666666666,1-2 quarters,0.7656058751529988,0
Egypt,2023,81.6,6.8,3.2,0.4705882352941177,0.32,1-2 quarters,0.7647058823529411,0
Sierra Leone,2023,81.39999999999999,6.783333333333332,3.216666666666668,0.4742014742014744,0.3216666666666667,1-2 quarters,0.7628992628992628,0
Turkey,2023,81.19999999999999,6.766666666666666,3.2333333333333343,0.4778325123152711,0.3233333333333335,1-2 quarters,0.7610837438423644,0
Russia,2023,80.7,6.7250000000000005,3.2749999999999995,0.486988847583643,0.3275,1-2 quarters,0.7565055762081785,0
Cambodia,2023,80.30000000000001,6.691666666666667,3.3083333333333327,0.49439601494396,0.3308333333333332,1-2 quarters,0.75280199252802,0
Nepal,2023,80.2,6.683333333333334,3.3166666666666664,0.4962593516209476,0.3316666666666666,1-2 quarters,0.7518703241895262,0
Solomon Islands,2023,79.60000000000001,6.633333333333334,3.3666666666666663,0.5075376884422109,0.3366666666666665,2-4 quarters,0.7462311557788945,0
Honduras,2023,79.6,6.633333333333333,3.366666666666667,0.5075376884422111,0.3366666666666666,2-4 quarters,0.7462311557788944,0
Swaziland,2023,79.1,6.591666666666666,3.408333333333334,0.5170670037926677,0.3408333333333334,2-4 quarters,0.7414664981036662,0
Colombia,2023,78.1,6.508333333333333,3.491666666666667,0.5364916773367479,0.3491666666666667,2-4 quarters,0.7317541613316261,0
Papua New Guinea,2023,78.1,6.508333333333333,3.491666666666667,0.5364916773367479,0.3491666666666667,2-4 quarters,0.7317541613316261,0
Philippines,2023,77.8,6.483333333333333,3.5166666666666666,0.5424164524421594,0.3516666666666667,2-4 quarters,0.7287917737789202,0
Nicaragua,2023,77.7,6.4750000000000005,3.5249999999999995,0.5444015444015443,0.3524999999999999,2-4 quarters,0.7277992277992278,0
Timor-Leste,2023,77.5,6.458333333333333,3.541666666666667,0.5483870967741936,0.3541666666666666,2-4 quarters,0.7258064516129032,0
Guatemala,2023,77.3,6.441666666666666,3.5583333333333336,0.5523932729624839,0.3558333333333333,2-4 quarters,0.7238033635187581,0
Tanzania,2023,76.6,6.383333333333333,3.616666666666667,0.5665796344647521,0.3616666666666667,2-4 quarters,0.7167101827676239,0
Lesotho,2023,76.3,6.358333333333333,3.6416666666666666,0.5727391874180865,0.3641666666666666,2-4 quarters,0.7136304062909568,0
Gambia,2023,76.10000000000001,6.341666666666668,3.658333333333332,0.576872536136662,0.3658333333333332,2-4 quarters,0.711563731931669,0
Jordan,2023,75.7,6.308333333333334,3.6916666666666655,0.5852047556142668,0.3691666666666666,2-4 quarters,0.7073976221928666,0
Kyrgyz Republic,2023,75.60000000000001,6.300000000000001,3.6999999999999993,0.5873015873015871,0.3699999999999999,2-4 quarters,0.7063492063492065,0
Laos,2023,74.69999999999999,6.224999999999999,3.775000000000001,0.6064257028112453,0.3775,2-4 quarters,0.6967871485943773,0
Brazil,2023,74.5,6.208333333333333,3.791666666666667,0.6107382550335572,0.3791666666666666,2-4 quarters,0.6946308724832214,0
Tajikistan,2023,74.2,6.183333333333334,3.8166666666666655,0.6172506738544474,0.3816666666666666,2-4 quarters,0.6913746630727763,0
India,2023,74.10000000000001,6.175000000000001,3.8249999999999993,0.6194331983805667,0.3824999999999999,2-4 quarters,0.6902834008097167,0
Benin,2023,73.30000000000001,6.108333333333334,3.8916666666666657,0.637107776261937,0.3891666666666665,2-4 quarters,0.6814461118690315,0
Peru,2023,73.10000000000001,6.091666666666668,3.908333333333332,0.6415868673050613,0.3908333333333332,2-4 quarters,0.6792065663474693,0
Azerbaijan,2023,72.69999999999999,6.058333333333333,3.9416666666666673,0.6506189821182945,0.3941666666666668,2-4 quarters,0.6746905089408528,0
Bosnia and Herzegovina,2023,72.3,6.025,3.975000000000001,0.6597510373443984,0.3975000000000001,2-4 quarters,0.6701244813278008,0
South Africa,2023,72.0,6.0,4.0,0.6666666666666666,0.4,2-4 quarters,0.6666666666666667,0
Georgia,2023,71.89999999999999,5.991666666666666,4.008333333333334,0.6689847009735745,0.4008333333333334,2-4 quarters,0.6655076495132127,0
Senegal,2023,71.50000000000001,5.958333333333335,4.041666666666665,0.6783216783216779,0.4041666666666665,2-4 quarters,0.660839160839161,0
Bolivia,2023,70.7,5.891666666666667,4.108333333333333,0.6973125884016973,0.4108333333333333,2-4 quarters,0.6513437057991514,0
Fiji,2023,70.19999999999999,5.849999999999999,4.150000000000001,0.7094017094017098,0.4150000000000001,2-4 quarters,0.6452991452991451,0
Algeria,2023,69.99999999999999,5.833333333333332,4.166666666666668,0.7142857142857146,0.4166666666666667,2-4 quarters,0.6428571428571427,1
Belarus,2023,69.9,5.825,4.175,0.7167381974248926,0.4175,2-4 quarters,0.6416309012875536,0
Mexico,2023,69.8,5.816666666666666,4.183333333333334,0.7191977077363898,0.4183333333333333,2-4 quarters,0.6404011461318051,0
Sao Tome and Principe,2023,69.7,5.808333333333334,4.191666666666666,0.721664275466284,0.4191666666666667,2-4 quarters,0.639167862266858,0
Ecuador,2023,69.39999999999999,5.783333333333332,4.216666666666668,0.7291066282420753,0.4216666666666667,2-4 quarters,0.6354466858789624,0
Micronesia,2023,69.30000000000001,5.775000000000001,4.224999999999999,0.7316017316017313,0.4224999999999999,2-4 quarters,0.6341991341991344,0
El Salvador,2023,69.3,5.775,4.2250000000000005,0.7316017316017318,0.4225,2-4 quarters,0.6341991341991341,0
Morocco,2023,68.19999999999999,5.683333333333333,4.316666666666667,0.7595307917888565,0.4316666666666667,2-4 quarters,0.6202346041055717,0
Thailand,2023,68.0,5.666666666666667,4.333333333333333,0.7647058823529411,0.4333333333333333,2-4 quarters,0.6176470588235294,0
Serbia,2023,67.9,5.658333333333334,4.341666666666666,0.767304860088365,0.4341666666666666,2-4 quarters,0.6163475699558175,0
Armenia,2023,67.5,5.625,4.375,0.7777777777777778,0.4375,2-4 quarters,0.6111111111111112,0
Moldova,2023,67.39999999999999,5.616666666666666,4.383333333333334,0.7804154302670624,0.4383333333333333,2-4 quarters,0.6097922848664687,0
Uzbekistan,2023,66.80000000000001,5.566666666666667,4.433333333333333,0.7964071856287424,0.4433333333333332,2-4 quarters,0.6017964071856288,0
Bhutan,2023,66.4,5.533333333333334,4.466666666666666,0.8072289156626503,0.4466666666666666,4-6 quarters,0.5963855421686748,0
Tunisia,2023,66.39999999999999,5.533333333333332,4.466666666666668,0.807228915662651,0.4466666666666667,4-6 quarters,0.5963855421686746,0
Indonesia,2023,65.60000000000001,5.466666666666668,4.533333333333332,0.8292682926829265,0.4533333333333332,4-6 quarters,0.5853658536585368,0
Gabon,2023,65.50000000000001,5.458333333333335,4.541666666666665,0.8320610687022896,0.4541666666666665,4-6 quarters,0.5839694656488552,0
Saudi Arabia,2023,65.3,5.441666666666666,4.558333333333334,0.8376722817764166,0.4558333333333333,4-6 quarters,0.5811638591117917,0`;

/* ===================== Helpers and state ===================== */
const eps = 1e-6;
function clamp01(v){ return Math.max(0+eps, Math.min(1-eps, v)); }
function logit(p){ p = clamp01(p); return Math.log(p/(1-p)); }
function norm01(v,min,max){ if (max-min<eps) return 0.5; return (v-min)/(max-min); }

let csvCases = [];         // parsed records
let caseVisibility = {};   // key -> boolean
let customCases = [];      // {name, X,Y,Z, ...}

const caseListDiv = document.getElementById('caseList');
const searchInput = document.getElementById('search');
const selectAllBtn = document.getElementById('selectAll');
const selectNoneBtn = document.getElementById('selectNone');
const insight = document.getElementById('insight');

/* ===================== Parse CSV ===================== */
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  const header = lines.shift().split(',');
  const idx = {}; header.forEach((h,i)=> idx[h.trim()] = i);
  const out = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const cols = line.split(',');
    const o = (k)=> cols[idx[k]] !== undefined ? cols[idx[k]].trim() : '';
    const obj = {
      Country: o('Country'),
      Year: +o('Year'),
      V_total: +o('V_total'),
      R: +o('R'),
      capacity_factor: +o('capacity_factor'),
      R_V_ratio: +o('R_V_ratio'),
      rupture_probability: +o('rupture_probability'),
      rupture_occurred: +o('rupture_occurred')
    };
    if (isFinite(obj.capacity_factor) && isFinite(obj.R) && isFinite(obj.rupture_probability)) out.push(obj);
  }
  return out;
}
csvCases = parseCSV(CSV_DATA);

/* ===================== Bands & colors ===================== */
function bandFromRV(rv){ if (rv < 0.30) return '1-2 quarters'; if (rv < 0.45) return '2-4 quarters'; if (rv < 0.60) return '4-6 quarters'; return '8+ quarters'; }
function bandAllowed(label){
  const m = {
    '1-2 quarters': document.getElementById('band4').checked,
    '2-4 quarters': document.getElementById('band3').checked,
    '4-6 quarters': document.getElementById('band2').checked,
    '8+ quarters': document.getElementById('band1').checked
  };
  return !!m[label];
}
function bandColor(rv){ if (rv<0.30) return '#ef4444'; if (rv<0.45) return '#f59e0b'; if (rv<0.60) return '#84cc16'; return '#16a34a'; }
function caseKey(c){ return `${c.Country} (${c.Year})`; }

/* ===================== Surfaces ===================== */
function buildStylizedSurface(useLogit=false){
  const xs = Array.from({length: 40}, (_, i) => i/39);
  const ys = Array.from({length: 40}, (_, i) => i/39);
  const z = [];
  for (let yi=0; yi<ys.length; yi++){
    const row=[];
    for (let xi=0; xi<xs.length; xi++){
      const x=xs[xi], y=ys[yi];
      const peak = Math.exp(-((x-0.9)**2 + (y-0.95)**2)*14) * 0.28;
      const valley= -Math.exp(-((x-0.30)**2 + (y-0.10)**2)*16) * 0.32;
      let zval = Math.max(0, Math.min(1, 0.35 - peak + valley));
      row.push(useLogit ? logit(zval) : zval);
    }
    z.push(row);
  }
  return {xs, ys, z};
}

function buildFittedSurface(points, sigma=0.2, gridN=40, useNormalize=false, useLogit=false){
  if (!points.length) return null;
  const xMin = Math.min(...points.map(p=>p.x)), xMax = Math.max(...points.map(p=>p.x));
  const yMin = Math.min(...points.map(p=>p.y)), yMax = Math.max(...points.map(p=>p.y));
  const P = points.map(p => {
    const X = useNormalize ? norm01(p.x, xMin, xMax) : p.x;
    const Y = useNormalize ? norm01(p.y, yMin, yMax) : p.y;
    let Z = p.z; Z = useLogit ? logit(clamp01(Z)) : Z;
    return {X,Y,Z};
  });
  const xs = Array.from({length: gridN}, (_, i)=> i/(gridN-1));
  const ys = Array.from({length: gridN}, (_, i)=> i/(gridN-1));
  const z = [];
  for (let yi=0; yi<ys.length; yi++){
    const row=[];
    for (let xi=0; xi<xs.length; xi++){
      const xg=xs[xi], yg=ys[yi];
      let num=0, den=0;
      for (const p of P){
        const r2 = ((xg-p.X)**2 + (yg-p.Y)**2)/(sigma*sigma);
        const k = Math.exp(-r2);
        num += k*p.Z; den += k;
      }
      row.push(den>1e-9 ? num/den : 0.5);
    }
    z.push(row);
  }
  return {xs, ys, z};
}

function buildResidualSurface(theory, fitted){
  if (!theory || !fitted) return null;
  const nY = Math.min(theory.z.length, fitted.z.length);
  const nX = Math.min(theory.z[0].length, fitted.z[0].length);
  const z = [];
  for (let yi=0; yi<nY; yi++){
    const row=[];
    for (let xi=0; xi<nX; xi++){
      row.push(fitted.z[yi][xi] - theory.z[yi][xi]);
    }
    z.push(row);
  }
  return {xs:fitted.xs, ys:fitted.ys, z};
}

/* ===================== Trajectories ===================== */
const pluralistTr = { x:[0.15,0.30,0.50,0.72,0.90], y:[0.25,0.45,0.62,0.80,0.95], z:[0.55,0.40,0.28,0.20,0.15],
  mode:'lines+markers', type:'scatter3d', name:'Pluralist/Utopian',
  line:{color:'#22c55e',width:4}, marker:{color:'#22c55e',size:4},
  text:['Start','Reciprocity','Repair event','Consolidation','Stable peak'], hoverinfo:'text' };
const authoritarianTr = { x:[0.25,0.32,0.40,0.46,0.52], y:[0.30,0.34,0.38,0.40,0.42], z:[0.40,0.42,0.44,0.47,0.50],
  mode:'lines+markers', type:'scatter3d', name:'Authoritarian',
  line:{color:'#f59e0b',width:4}, marker:{color:'#f59e0b',size:4},
  text:['Start','Enforcement spike','Stagnation','Contradictions','Brittle plateau'], hoverinfo:'text' };
const collapsedTr = { x:[0.30,0.26,0.22,0.18,0.14], y:[0.28,0.24,0.20,0.16,0.12], z:[0.50,0.58,0.65,0.73,0.80],
  mode:'lines+markers', type:'scatter3d', name:'Collapsed/Anomic',
  line:{color:'#ef4444',width:4}, marker:{color:'#ef4444',size:4},
  text:['Start','Obligation denial','Trust shock','Cascade','Rupture valley'], hoverinfo:'text' };

/* ===================== Case list UI ===================== */
function filteredCases(){
  const q = (document.getElementById('search').value || '').toLowerCase();
  return csvCases.filter(c => {
    const label = caseKey(c).toLowerCase();
    if (!label.includes(q)) return false;
    const band = bandFromRV(c.R_V_ratio);
    return bandAllowed(band);
  });
}
function buildCaseList(){
  caseListDiv.innerHTML='';
  filteredCases().forEach(c=>{
    const key = caseKey(c);
    if (!(key in caseVisibility)) caseVisibility[key] = true;
    const row = document.createElement('div'); row.className='case-item';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!caseVisibility[key];
    cb.addEventListener('change', ()=>{ caseVisibility[key]=cb.checked; render(); });
    const dot = document.createElement('span'); dot.className='dot'; dot.style.background = bandColor(c.R_V_ratio);
    const label = document.createElement('span'); label.textContent = key;
    row.appendChild(cb); row.appendChild(dot); row.appendChild(label);
    caseListDiv.appendChild(row);
  });
}
document.getElementById('search').addEventListener('input', buildCaseList);
document.getElementById('selectAll').addEventListener('click', ()=>{ filteredCases().forEach(c=> caseVisibility[caseKey(c)]=true); buildCaseList(); render(); });
document.getElementById('selectNone').addEventListener('click', ()=>{ filteredCases().forEach(c=> caseVisibility[caseKey(c)]=false); buildCaseList(); render(); });

/* ===================== Build traces (static vs. trajectories) ===================== */
function buildCaseTracesStatic(){
  const showLabels = document.getElementById('showLabels').checked;
  const useNorm = document.getElementById('normalizeXY').checked;
  const useLog = document.getElementById('logitZ').checked;

  let xMin, xMax, yMin, yMax;
  if (useNorm && csvCases.length>0){
    xMin = Math.min(...csvCases.map(c=>c.capacity_factor));
    xMax = Math.max(...csvCases.map(c=>c.capacity_factor));
    yMin = Math.min(...csvCases.map(c=>c.R));
    yMax = Math.max(...csvCases.map(c=>c.R));
  }

  const base = { type:'scatter3d', mode: showLabels? 'markers+text':'markers', textposition:'top center', marker:{ size:5, symbol:'diamond' } };
  const bands = {
    '1-2 quarters': { name:'Cases: 1–2 q', color:'#ef4444', xs:[], ys:[], zs:[], texts:[], hover:[] },
    '2-4 quarters': { name:'Cases: 2–3 q', color:'#f59e0b', xs:[], ys:[], zs:[], texts:[], hover:[] },
    '4-6 quarters': { name:'Cases: 3–6 q', color:'#84cc16', xs:[], ys:[], zs:[], texts:[], hover:[] },
    '8+ quarters': { name:'Cases: 8+ q', color:'#16a34a', xs:[], ys:[], zs:[], texts:[], hover:[] }
  };

  csvCases.forEach(c=>{
    const key = caseKey(c);
    const band = bandFromRV(c.R_V_ratio);
    if (!bandAllowed(band)) return;
    if (caseVisibility[key] === false) return;

    let X = c.capacity_factor, Y = c.R, Z = c.rupture_probability;
    if (useNorm){ X = norm01(X, xMin, xMax); Y = norm01(Y, yMin, yMax); }
    if (useLog){ Z = logit(clamp01(Z)); }

    const txt = showLabels ? key : '';
    const hv = `${key}<br>R/V: ${c.R_V_ratio.toFixed(3)}<br>Z: ${c.rupture_probability.toFixed(3)}${useLog?' (logit)':''}<br>V_total: ${c.V_total?.toFixed(3)}<br>R (eff): ${c.R?.toFixed(3)}<br>capacity: ${c.capacity_factor?.toFixed(3)}<br>Band: ${band}<br>Occurred: ${c.rupture_occurred}`;
    const bucket = bands[band];
    bucket.xs.push(X); bucket.ys.push(Y); bucket.zs.push(Z);
    bucket.texts.push(txt); bucket.hover.push(hv);
  });

  return Object.values(bands).map(b=>({
    ...base, name:b.name, x:b.xs, y:b.ys, z:b.zs, text:b.texts, hovertext:b.hover, hoverinfo:'text',
    marker:{ ...base.marker, color:b.color }
  }));
}

function buildCaseTracesTraj(){
  // Group by country; connect by year
  const showLabels = document.getElementById('showLabels').checked;
  const useNorm = document.getElementById('normalizeXY').checked;
  const useLog = document.getElementById('logitZ').checked;

  let xMin, xMax, yMin, yMax;
  if (useNorm && csvCases.length>0){
    xMin = Math.min(...csvCases.map(c=>c.capacity_factor));
    xMax = Math.max(...csvCases.map(c=>c.capacity_factor));
    yMin = Math.min(...csvCases.map(c=>c.R));
    yMax = Math.max(...csvCases.map(c=>c.R));
  }

  const byCountry = {};
  csvCases.forEach(c => {
    const key = caseKey(c);
    if (caseVisibility[key] === false) return; // respect toggles
    if (!byCountry[c.Country]) byCountry[c.Country] = [];
    byCountry[c.Country].push(c);
  });

  const traces = [];
  const colors = ['#60a5fa','#34d399','#f87171','#fbbf24','#a78bfa','#22d3ee','#f472b6','#c084fc','#4ade80','#f59e0b'];
  let ci = 0;

  for (const country of Object.keys(byCountry)){
    const arr = byCountry[country].sort((a,b)=> a.Year - b.Year);
    const X=[],Y=[],Z=[], T=[], H=[];
    arr.forEach(c=>{
      let x = c.capacity_factor, y=c.R, z=c.rupture_probability;
      if (useNorm){ x = norm01(x,xMin,xMax); y=norm01(y,yMin,yMax); }
      if (useLog){ z = logit(clamp01(z)); }
      X.push(x); Y.push(y); Z.push(z);
      T.push(showLabels? `${c.Country} ${c.Year}` : '');
      H.push(`${c.Country} (${c.Year})<br>R/V: ${c.R_V_ratio.toFixed(3)}<br>Z: ${c.rupture_probability.toFixed(3)}${useLog?' (logit)':''}<br>R: ${c.R.toFixed(3)} | cap: ${c.capacity_factor.toFixed(3)}`);
    });

    traces.push({
      type:'scatter3d', mode: showLabels? 'lines+markers+text':'lines+markers',
      name: country,
      x:X, y:Y, z:Z,
      text:T, hovertext:H, hoverinfo:'text', textposition:'top center',
      line:{ color: colors[ci % colors.length], width:3 },
      marker:{ color: colors[ci % colors.length], size:4 }
    });
    ci++;
  }
  return traces;
}

/* ===================== Build surfaces & residuals ===================== */
function toPoints(){ return csvCases.map(c => ({x:c.capacity_factor, y:c.R, z:c.rupture_probability})); }

function buildSurfaceTraces(){
  const useLog = document.getElementById('logitZ').checked;
  const useNorm= document.getElementById('normalizeXY').checked;
  const sigma  = +document.getElementById('sigma').value;

  const traces=[];
  const theory = buildStylizedSurface(useLog);
  if (document.getElementById('toggleStylized').checked){
    traces.push({ type:'surface', x:theory.xs, y:theory.ys, z:theory.z, colorscale:'YlGnBu', opacity:0.35, showscale:false, name:'Stylized terrain' });
  }
  if (document.getElementById('toggleFitted').checked && csvCases.length>0){
    const fit = buildFittedSurface(toPoints(), sigma, 40, useNorm, useLog);
    traces.push({
      type:'surface', x:fit.xs, y:fit.ys, z:fit.z, colorscale:'Cividis', opacity:0.42, showscale:false, name:'Fitted terrain',
      contours:{ z:{ show: document.getElementById('toggleContours').checked, usecolormap:false, highlightcolor:'#ffffff', project:{z:true} } }
    });
    if (document.getElementById('toggleResiduals').checked){
      const residual = buildResidualSurface(theory, fit);
      const planeZ = residual.z.map(row => row.map(()=> 0.0));
      traces.push({
        type:'surface', x:residual.xs, y:residual.ys, z:planeZ,
        surfacecolor: residual.z, colorscale:'RdBu', reversescale:true,
        opacity:0.55, showscale:true, colorbar:{title:'Residual (data − theory)'}, name:'Residuals'
      });
    }
  }
  return traces;
}

/* ===================== Plot & interactions ===================== */
const layout = {
  margin:{l:0,r:0,b:0,t:0},
  scene:{
    xaxis:{ title:'Trust density (X) = capacity_factor' },
    yaxis:{ title:'Fulfillment proxy (Y) = effective repair (R)' },
    zaxis:{ title:'Debt proxy (Z) = rupture_probability = 1 − R/V' },
    camera:{ eye:{x:1.6,y:1.6,z:0.9} }
  },
  legend:{ x:0.02, y:0.98, font:{color:'#e6e8ee'} },
  paper_bgcolor:'#0e1116', plot_bgcolor:'#0e1116', font:{ color:'#e6e8ee' }
};

function render(){
  const traces = [];
  // surfaces
  buildSurfaceTraces().forEach(t=> traces.push(t));
  // regime trajectories
  if (document.getElementById('togglePluralist').checked) traces.push(pluralistTr);
  if (document.getElementById('toggleAuthoritarian').checked) traces.push(authoritarianTr);
  if (document.getElementById('toggleCollapsed').checked) traces.push(collapsedTr);
  // cases (static vs trajectories)
  const traj = document.getElementById('modeTraj').checked;
  const caseTrs = traj ? buildCaseTracesTraj() : buildCaseTracesStatic();
  caseTrs.forEach(t=> traces.push(t));
  // custom cases
  const customTr = buildCustomTrace(); if (customTr) traces.push(customTr);

  Plotly.newPlot('plot', traces, layout);
}

document.getElementById('plot').on('plotly_click', function(evt){
  const pt = evt.points?.[0]; if (!pt) return;
  const series = pt.data.name || '';
  const x = +pt.x, y=+pt.y, z=+pt.z;
  let msg = `<b>Series:</b> ${series}<br><b>X (trust):</b> ${x.toFixed(3)} <b>Y (repair eff.):</b> ${y.toFixed(3)} <b>Z:</b> ${z.toFixed(3)}<br>`;
  if (series.startsWith('Cases:') || document.getElementById('modeTraj').checked){
    // Best-effort: show hovertext already includes decomposition
    msg += pt.data.hovertext ? pt.data.hovertext[pt.pointIndex] : '(case)';
  } else if (series === 'Custom cases'){
    msg += `(custom case)`;
  } else if (series.includes('Pluralist')){
    msg += `Obligations reciprocated and repaired; climb toward stable basin.`;
  } else if (series.includes('Authoritarian')){
    msg += `Compliance without internalization; brittle plateau with creeping debt.`;
  } else if (series.includes('Collapsed')){
    msg += `Denial of obligations; descent into rupture valley.`;
  } else if (series.includes('Residual')){
    msg += `Residual = data − theory (after transforms). Red = worse than theory; blue = better.`;
  } else {
    msg += `Terrain surface (theory/data). Peaks ≈ stability; valleys ≈ rupture.`;
  }
  document.getElementById('insight').innerHTML = msg;
});

/* ===================== Custom cases ===================== */
function buildCustomTrace(){
  if (!customCases.length) return null;
  return {
    type:'scatter3d', mode:'markers+text', name:'Custom cases',
    x: customCases.map(c=>c.X), y: customCases.map(c=>c.Y), z: customCases.map(c=>c.Z),
    text: customCases.map(c=>c.name),
    hovertext: customCases.map(c=> `${c.name}<br>R/V: ${c.rv} | R_eff: ${c.R_eff}<br>X=${c.X}, Y=${c.Y}, Z=${c.Z}`),
    hoverinfo:'text', textposition:'top center',
    marker:{ size:7, color:'#a78bfa', symbol:'diamond-open' }
  };
}

document.getElementById('addCase').addEventListener('click', ()=>{
  const name = (document.getElementById('caseName').value||'').trim() || `Custom ${customCases.length+1}`;
  const V = Math.max(0, Math.min(2, parseFloat(document.getElementById('V').value)));
  const Ravg = Math.max(0, Math.min(1, parseFloat(document.getElementById('Ravg').value)));
  const Cap = Math.max(0, Math.min(1, parseFloat(document.getElementById('Cap').value)));
  const Xov = document.getElementById('Xoverride').value;
  const R_eff = +(Ravg*Cap).toFixed(4);
  const rv = (V>0)? +(R_eff/V).toFixed(4) : null;
  const X = Xov ? Math.max(0, Math.min(1, +Xov)) : Cap;
  const Y = R_eff;
  const Z = rv!=null ? +(1 - rv).toFixed(4) : null;
  const idx = customCases.findIndex(c=> c.name.toLowerCase()===name.toLowerCase());
  const entry = { name, X, Y, Z, rv, R_eff, V, Cap, Ravg };
  if (idx>=0) customCases[idx]=entry; else customCases.push(entry);
  document.getElementById('insight').innerHTML = `<b>Custom case:</b> ${name}<br>R_eff: ${R_eff} | R/V: ${rv} | Map: X=${X}, Y=${Y}, Z=${Z}`;
  render();
});
document.getElementById('clearCases').addEventListener('click', ()=>{ customCases=[]; document.getElementById('insight').innerHTML='Custom cases cleared.'; render(); });

/* ===================== Wire up controls & init ===================== */
[
  'modeStatic','modeTraj','toggleStylized','toggleFitted','toggleContours','toggleResiduals',
  'togglePluralist','toggleAuthoritarian','toggleCollapsed','toggleCases',
  'band1','band2','band3','band4','showLabels','normalizeXY','logitZ','sigma'
].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('change', ()=>{ buildCaseList(); render(); });
});

buildCaseList();
render();
</script>
</body>
</html>
